name: Android Signed Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., v0.2.1)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: boolean
        default: false

env:
  ANDROID_SDK_VERSION: 35
  ANDROID_BUILD_TOOLS_VERSION: 35.0.0
  ANDROID_NDK_VERSION: 27.3.13750724

jobs:
  build-signed:
    name: Build Signed Release APK
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_SDK_VERSION }}
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          build-tools-version: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
          cmake-version: 3.22.1

      - name: Create keystore from secrets
        run: |
          # Decode base64 encoded keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ${{ runner.temp }}/release.keystore
          
          # Verify keystore
          keytool -list -v -keystore ${{ runner.temp }}/release.keystore \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" | head -20

      - name: Build Signed Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease \
            -PSTORE_FILE=${{ runner.temp }}/release.keystore \
            -PSTORE_PASSWORD="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -PKEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}" \
            -PKEY_PASSWORD="${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --stacktrace
        env:
          ORG_GRADLE_PROJECT_org_gradle_jvmargs: "-Xmx2g"
          SIGNING_STORE_PATH: ${{ runner.temp }}/release.keystore
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Verify signed APK
        run: |
          cd android/build/outputs/apk/release
          
          echo "=== APK Files ===" 
          ls -lh *.apk
          
          echo ""
          echo "=== APK Signature ===" 
          jarsigner -verify -verbose android-release.apk | grep "verified"
          
          echo ""
          echo "=== APK Info ===" 
          aapt dump badging android-release.apk | grep -E "package:|versionName:|versionCode:"

      - name: Calculate checksums
        id: checksums
        run: |
          cd android/build/outputs/apk/release
          
          echo "SHA256=$(sha256sum android-release.apk | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "MD5=$(md5sum android-release.apk | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "SIZE=$(du -h android-release.apk | cut -f1)" >> $GITHUB_OUTPUT

      - name: Upload signed APK
        uses: actions/upload-artifact@v3
        with:
          name: vita3k-signed-release-${{ inputs.version }}
          path: android/build/outputs/apk/release/android-release.apk
          retention-days: 90

      - name: Create GitHub Release
        if: inputs.create_release == true
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ inputs.version }}
          name: "Vita3K ${{ inputs.version }}"
          prerelease: false
          draft: false
          artifacts: android/build/outputs/apk/release/android-release.apk
          bodyFile: release_notes.md
          allowUpdates: false
          replacesArtifacts: false
          makeLatest: true

      - name: Create release notes
        run: |
          cat > release_notes.md << 'EOF'
          # Vita3K Android ${{ inputs.version }}
          
          ## Release Information
          - **Version**: ${{ inputs.version }}
          - **Build Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          - **Git Commit**: ${{ github.sha }}
          - **Git Branch**: ${{ github.ref_name }}
          
          ## APK Information
          - **Filename**: android-release.apk
          - **Size**: ${{ steps.checksums.outputs.SIZE }}
          - **SHA256**: `${{ steps.checksums.outputs.SHA256 }}`
          - **MD5**: `${{ steps.checksums.outputs.MD5 }}`
          
          ## Installation Instructions
          
          ### Requirements
          - Android 9.0 (API level 28) or higher
          - ARM64 processor (aarch64)
          - At least 4GB free storage
          
          ### Steps
          1. Download the APK file
          2. Enable "Unknown Sources" in Android settings
          3. Install: `adb install -r android-release.apk`
          4. Or tap the APK file on your device
          
          ## Changelog
          See [GitHub Commits](https://github.com/Vita3K/Vita3K/commits/${{ github.sha }}) for detailed changes.
          
          ## Support
          - **Discord**: https://discord.gg/6aGwQzh
          - **Issues**: https://github.com/Vita3K/Vita3K/issues
          - **Wiki**: https://github.com/Vita3K/Vita3K/wiki
          EOF

      - name: Build Summary
        run: |
          echo "## Signed Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          echo "| APK Size | ${{ steps.checksums.outputs.SIZE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA256 | \`${{ steps.checksums.outputs.SHA256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| MD5 | \`${{ steps.checksums.outputs.MD5 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Signed | ✅ Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Created | ${{ inputs.create_release }} |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f ${{ runner.temp }}/release.keystore
