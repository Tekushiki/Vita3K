name: Android Build

on:
  push:
    branches:
      - master
      - develop
    paths:
      - 'android/**'
      - 'vita3k/**'
      - 'external/**'
      - 'CMakeLists.txt'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'android/**'
      - 'vita3k/**'
      - 'external/**'
      - 'CMakeLists.txt'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - reldebug
          - release

env:
  ANDROID_SDK_VERSION: 35
  ANDROID_BUILD_TOOLS_VERSION: 35.0.0
  ANDROID_NDK_VERSION: 27.3.13750724
  GRADLE_VERSION: 8.1.1

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        build_type: [debug, reldebug, release]
        exclude:
          # Jika workflow_dispatch dengan build_type spesifik, hanya build yang dipilih
          - build_type: ${{ github.event.inputs.build_type != '' && github.event.inputs.build_type != matrix.build_type && matrix.build_type || '' }}
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_SDK_VERSION }}
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          build-tools-version: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
          cmake-version: 3.22.1

      - name: Verify environment
        run: |
          echo "=== Java ===" 
          java -version
          echo ""
          echo "=== Android SDK ===" 
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "NDK: $(ls -d $ANDROID_HOME/ndk/* 2>/dev/null | head -1)"
          echo ""
          echo "=== Gradle ===" 
          ./android/gradlew --version

      - name: Cache Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' && github.ref != 'refs/heads/develop' }}

      - name: Cache CMake build
        uses: actions/cache@v3
        with:
          path: |
            android/build/.cmake
            android/.gradle/cxx
          key: ${{ runner.os }}-cmake-${{ hashFiles('vita3k/**', 'external/**', 'CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      - name: Lint Android project
        if: matrix.build_type == 'debug'
        run: |
          cd android
          chmod +x gradlew
          ./gradlew lintDebug || true

      - name: Build Debug APK
        if: matrix.build_type == 'debug'
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace
        env:
          ORG_GRADLE_PROJECT_org_gradle_jvmargs: "-Xmx2g"

      - name: Build Release-Debug APK
        if: matrix.build_type == 'reldebug'
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleReldebug --stacktrace
        env:
          ORG_GRADLE_PROJECT_org_gradle_jvmargs: "-Xmx2g"

      - name: Build Release APK
        if: matrix.build_type == 'release'
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace
        env:
          ORG_GRADLE_PROJECT_org_gradle_jvmargs: "-Xmx2g"

      - name: Get APK info
        id: apk_info
        run: |
          cd android/build/outputs/apk
          
          # Find APK file
          APK_FILE=$(find . -name "*.apk" | head -1)
          
          if [ -z "$APK_FILE" ]; then
            echo "APK_SIZE=0"
            echo "APK_PATH=Not found"
          else
            APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
            APK_PATH="$APK_FILE"
            echo "APK_SIZE=$APK_SIZE"
            echo "APK_PATH=$APK_PATH"
            echo "APK_FILE=$(basename $APK_FILE)"
          fi

      - name: Upload Debug APK
        if: matrix.build_type == 'debug' && success()
        uses: actions/upload-artifact@v3
        with:
          name: vita3k-debug-apk
          path: android/build/outputs/apk/debug/
          retention-days: 30
          compression-level: 0

      - name: Upload RelDebug APK
        if: matrix.build_type == 'reldebug' && success()
        uses: actions/upload-artifact@v3
        with:
          name: vita3k-reldebug-apk
          path: android/build/outputs/apk/reldebug/
          retention-days: 30
          compression-level: 0

      - name: Upload Release APK
        if: matrix.build_type == 'release' && success()
        uses: actions/upload-artifact@v3
        with:
          name: vita3k-release-apk
          path: android/build/outputs/apk/release/
          retention-days: 30
          compression-level: 0

      - name: Build Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ matrix.build_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "android/build/outputs/apk/debug/android-debug.apk" ]; then
            SIZE=$(du -h "android/build/outputs/apk/debug/android-debug.apk" | cut -f1)
            echo "| Debug APK Size | $SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "android/build/outputs/apk/release/android-release.apk" ]; then
            SIZE=$(du -h "android/build/outputs/apk/release/android-release.apk" | cut -f1)
            echo "| Release APK Size | $SIZE |" >> $GITHUB_STEP_SUMMARY
          fi

  publish-artifacts:
    name: Publish Build Artifacts
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create release notes
        run: |
          echo "# Vita3K Android Build" > release_notes.md
          echo "" >> release_notes.md
          echo "**Build Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> release_notes.md
          echo "**Git Commit**: ${{ github.sha }}" >> release_notes.md
          echo "**Branch**: ${{ github.ref_name }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Downloaded Files" >> release_notes.md
          find . -name "*.apk" -type f | while read -r file; do
            echo "- \`$(basename $file)\` ($(du -h \"$file\" | cut -f1))" >> release_notes.md
          done

      - name: Upload to Nightly Release
        if: github.ref == 'refs/heads/master'
        uses: ncipollo/release-action@v1
        with:
          tag: nightly-${{ github.run_number }}
          name: "Nightly Build ${{ github.run_number }}"
          prerelease: true
          draft: false
          artifacts: "vita3k-*-apk/*.apk"
          bodyFile: release_notes.md
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: false
          makeLatest: false

  # Optional: Send notifications
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Build passed
        if: needs.build.result == 'success'
        run: |
          echo "✅ Android build passed!"
          echo "Build artifacts are ready for download."

      - name: Build failed
        if: needs.build.result == 'failure'
        run: |
          echo "❌ Android build failed!"
          echo "Check the logs for details."
        continue-on-error: true

      - name: Send Webhook (Discord - Optional)
        if: failure() && vars.DISCORD_WEBHOOK != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "Android Build ${{ needs.build.result }}"
          description: |
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
